<!-- Goalsetter Welcome Activity Component -->
<div class="activity-container goalsetter-welcome" role="form">
  <h1>Welcome to the GoalSetter!</h1>
  <p>You will be guided through an interview to help set affirming student-friendly goals you can print and hang on your PDSA board.</p>

  <div class="form-section standards-section">
    <h2>Standards Alignment</h2>
    <div class="radio-group">
      <label class="radio-option">
        <input type="radio" name="standards" value="yes" onchange="STAuth.handleStandardsChoice('yes')">
        <span>Yes, I want to align with standards</span>
      </label>
      <label class="radio-option">
        <input type="radio" name="standards" value="no" onchange="STAuth.handleStandardsChoice('no')">
        <span>No, skip standards alignment</span>
      </label>
    </div>
    
    <div id="standards-detail" class="context-section">
      <div class="form-group">
        <label for="standards-url">Standards URL</label>
        <input type="text" id="standards-url" placeholder="Enter standards reference URL">
      </div>
      <div class="form-group">
        <label for="standards-grade">Grade Level</label>
        <input type="text" id="standards-grade" placeholder="Enter grade level">
      </div>
      <div class="form-group">
        <label for="standards-subject">Subject Area</label>
        <input type="text" id="standards-subject" placeholder="Enter subject area">
      </div>
      <div class="form-group">
        <label for="standards-state">State/Jurisdiction</label>
        <input type="text" id="standards-state" placeholder="Enter state or jurisdiction">
      </div>
      <div id="standards-validation" class="validation-message">Please fill in all standards details</div>
    </div>
  </div>

  <div class="form-section reflection-section">
    <h2>Previous Goals Review</h2>
    <div class="radio-group">
      <label class="radio-option">
        <input type="radio" name="reflection" value="yes" onchange="STAuth.handleReflectionChoice('yes')">
        <span>Yes, I want to reflect on last week's goals</span>
      </label>
      <label class="radio-option">
        <input type="radio" name="reflection" value="no" onchange="STAuth.handleReflectionChoice('no')">
        <span>No, start fresh</span>
      </label>
    </div>
    
    <div id="reflection-detail" class="context-section">
      <div class="form-group">
        <label for="reflection-input">Your Reflection</label>
        <textarea id="reflection-input" class="rich-text" rows="4" placeholder="Reflect on your previous goals..."></textarea>
      </div>
      <div id="reflection-validation" class="validation-message">Please enter your reflection</div>
    </div>
  </div>
</div>

<style>
.goalsetter-welcome {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
}

.form-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: white;
}

.radio-group {
  display: flex;
  gap: 1.5rem;
  margin: 1rem 0;
}

.context-section {
  display: none;
  margin-top: 1rem;
  padding: 1rem;
  border-left: 3px solid var(--secondary-color);
  background: rgba(232, 119, 34, 0.05);
}

.context-section.visible {
  display: block;
}

.rich-text {
  width: 100%;
  min-height: 120px;
  padding: 1rem;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  resize: vertical;
}

.validation-message {
  display: none;
  color: var(--raspberry);
  margin-top: 0.5rem;
  font-size: 0.875rem;
}

.validation-message.visible {
  display: block;
}
</style>

<script>
// State Management
const state = {
  form: {
    standardsChoice: null,
    standardsLink: '',
    standardsDetail: '',
    reflectionChoice: null,
    reflectionDetail: ''
  },
  interview: {
    teachingContext: '',
    learningTarget: '',
    successCriteria: '',
    teacherGoalStatement: '',
    studentGoalStatement: '',
    messageCount: 0,
    isComplete: false
  }
};

function handleStandardsChoice(value) {
  state.form.standardsChoice = value;
  const detailSection = document.getElementById('standards-detail');
  detailSection.style.display = value === 'yes' ? 'block' : 'none';
  validateForm();
}

function validateForm() {
  const standardsChoice = state.form.standardsChoice;
  const standardsLink = document.getElementById('standards-url')?.value;
  const standardsGrade = document.getElementById('standards-grade')?.value;
  const standardsSubject = document.getElementById('standards-subject')?.value;
  const standardsState = document.getElementById('standards-state')?.value;
  const continueButton = document.getElementById('continue-button');
  const validationMessage = document.getElementById('standards-validation');
  
  let isValid = false;
  
  if (standardsChoice === 'no') {
    isValid = true;
    state.form.standardsLink = '';
    state.form.standardsDetail = '';
  } else if (standardsChoice === 'yes') {
    state.form.standardsLink = standardsLink.trim();
    state.form.standardsDetail = standardsGrade + ', ' + standardsSubject + ', ' + standardsState;
    isValid = state.form.standardsLink !== '' || state.form.standardsDetail !== '';
    validationMessage.style.display = isValid ? 'none' : 'block';
  }
  
  continueButton.disabled = !isValid;
  
  if (isValid) {
    continueButton.addEventListener('click', () => {
      sendToWebhook();
      const event = new CustomEvent('activityComplete', {
        detail: {
          type: 'goalsetterWelcome',
          data: {
            considerStandards: state.form.standardsChoice === 'yes',
            standardsLink: state.form.standardsLink,
            standardsDescription: state.form.standardsDetail,
            state: state // Include full state for parent component
          }
        }
      });
      document.dispatchEvent(event);
    });
  }
}

function sendToWebhook() {
  const payload = {
    user_data: {
      name: state.form.name || 'anonymous',
      email: state.form.email || 'anonymous@public.test',
      user_id: state.form.userId || '',
      thread_id: window.threadId || '',
      assistant_id: 'asst_IA5PsJxdShVPTAv2xeXTr4Ma',
      org_id: 'recsK5zK0CouK5ebW',
      intake_token: 'goalsetter_chat',
      source: 'url',
      url: window.location.href,
      is_anonymous: !state.form.name || !state.form.email
    },
    document_data: {
      subject_and_grade: state.interview.teachingContext || '',
      learning_target: state.interview.learningTarget || '',
      measure_of_success: state.interview.successCriteria || '',
      classroom_goal_statement: state.interview.teacherGoalStatement || ''
    },
    form_data: {
      standards: {
        consider: state.form.standardsChoice === 'yes',
        link: state.form.standardsLink,
        details: state.form.standardsDetail
      }
    }
  };

  fetch('https://hook.us1.make.com/f6no146taqm5cdss37za7siawjy8fnut', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Webhook response:', data);
    // Emit webhook completion event
    document.dispatchEvent(new CustomEvent('webhookComplete', { 
      detail: { success: true, data } 
    }));
  })
  .catch(error => {
    console.error('Webhook error:', error);
    document.dispatchEvent(new CustomEvent('webhookComplete', { 
      detail: { success: false, error } 
    }));
  });
}
</script> 
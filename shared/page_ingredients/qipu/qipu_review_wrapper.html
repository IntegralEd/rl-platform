<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Mode - Recursive Learning</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        :root {
            --primary: #0052CC;
            --secondary: #f2b632;
            --text: #333333;
            --background: #F5F6F7;
        }

        body, html {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        #validation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10010;
        }

        #review-container {
            display: none;
            height: 100vh;
        }

        #loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            padding: 10px;
            border-radius: 4px;
            background: #f8d7da;
            margin: 10px 0;
            display: none;
            max-width: 80%;
            text-align: center;
        }

        #content-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9000;
        }

        #annotation-canvas {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="validation-overlay">
        <div id="loader"></div>
        <p>Validating review access...</p>
        <div class="error-message" id="error-display"></div>
    </div>

    <div id="review-container">
        <iframe id="content-frame"></iframe>
        <div id="canvas-container">
            <canvas id="annotation-canvas"></canvas>
        </div>
    </div>

    <script src="/shared/page_ingredients/qipu/qipu_integration.js"></script>
    <script>
        // Configuration
        const WEBHOOK_URL = 'https://hook.us1.make.com/your-webhook-id';
        const SOFTR_API = 'https://integral-mothership.softr.app/api/v1';
        
        // Error handling
        function showError(message) {
            const errorDisplay = document.getElementById('error-display');
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
            document.getElementById('loader').style.display = 'none';
        }
        
        // Get and validate content URL
        function getContentUrl() {
            const params = new URLSearchParams(window.location.search);
            const targetUrl = params.get('target');
            
            if (!targetUrl) {
                showError('No content specified for review');
                return null;
            }
            
            try {
                const url = new URL(targetUrl);
                return url.toString();
            } catch(e) {
                showError('Invalid content URL provided');
                return null;
            }
        }
        
        // Validate review access and load content
        async function validateAccess() {
            const params = new URLSearchParams(window.location.search);
            const reviewEmail = params.get('RevEmail');
            const userId = params.get('User_ID');
            const orgId = params.get('Org_ID');
            const reviewToken = params.get('review_token');
            
            if (!reviewEmail && !reviewToken) {
                showError('Invalid review credentials');
                return;
            }
            
            const contentUrl = getContentUrl();
            if (!contentUrl) {
                return;
            }
            
            try {
                // For URL parameter authentication
                if (reviewEmail && userId && orgId) {
                    // Initialize the content frame with the target URL
                    initializeFrame(contentUrl);
                    
                    // Initialize Qipu review system
                    initializeQipu({
                        email: reviewEmail,
                        userId: userId,
                        orgId: orgId
                    });
                }
                // For token-based authentication
                else if (reviewToken) {
                    // Validate token with backend
                    // This is a placeholder for actual token validation
                    setTimeout(() => {
                        initializeFrame(contentUrl);
                        
                        // Initialize with dummy user data for now
                        initializeQipu({
                            email: 'reviewer@example.com',
                            userId: 'token_' + Date.now(),
                            orgId: 'token_org'
                        });
                    }, 1000);
                }
            } catch (error) {
                showError('Validation failed: ' + error.message);
                console.error(error);
            }
        }
        
        function initializeFrame(url) {
            document.getElementById('validation-overlay').style.display = 'none';
            document.getElementById('review-container').style.display = 'block';
            
            const contentFrame = document.getElementById('content-frame');
            contentFrame.src = url;
            
            // Setup message listener for communication with the iframe
            window.addEventListener('message', (event) => {
                // Validate origin
                const targetUrl = new URL(getContentUrl());
                if (event.origin !== targetUrl.origin) {
                    return;
                }
                
                // Handle messages from iframe
                if (event.data && event.data.type === 'qipu_ready') {
                    console.log('Content frame is ready for review');
                }
            });
        }
        
        function initializeQipu(userData) {
            // Wait for iframe to load before initializing Qipu
            const contentFrame = document.getElementById('content-frame');
            contentFrame.onload = () => {
                // Create review goal message
                const params = new URLSearchParams(window.location.search);
                const deadline = params.get('deadline') || 'two weeks';
                const focus = params.get('focus') || 'content accuracy and user experience';
                const reviewGoal = `Review this content by ${deadline}, focusing on ${focus}.`;
                
                // Initialize Qipu review system
                window.qipuReviewInstance = new QipuReview({
                    apiEndpoint: WEBHOOK_URL,
                    reviewerName: userData.email.split('@')[0],
                    reviewGoal: reviewGoal,
                    authRequired: true,
                    autoInitialize: true
                });
                
                // Authenticate the user
                qipuReviewInstance.authenticateUser(userData);
            };
        }
        
        // Start the validation and initialization process
        document.addEventListener('DOMContentLoaded', validateAccess);
    </script>
</body>
</html> 
<!DOCTYPE html>
<!-- Deploy: 2024-04-21 18:00 CST -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Merit - Teacher and Leader Support Chat for EL Education Language Arts Curriculum">
    <meta name="theme-color" content="#c6123f">
    <title>Merit - Teacher Support | EL Education</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/clients/elpl/assets/images/client-elpl-favicon.ico">
    
    <!-- Platform level styles -->
    <link rel="stylesheet" href="/shared/platform/css/platform-variables.css">
    <link rel="stylesheet" href="/shared/platform/css/platform-core.css">
    <link rel="stylesheet" href="/shared/platform/css/platform-loading-states.css">
    <link rel="stylesheet" href="/shared/platform/css/platform-animations.css">
    
    <!-- Client level styles -->
    <link rel="stylesheet" href="/clients/elpl/assets/css/client-elpl-variables.css">
    <link rel="stylesheet" href="/clients/elpl/assets/css/client-elpl.css">
    
    <!-- Project level styles -->
    <link rel="stylesheet" href="assets/css/client-merit-chat.css">
    
    <!-- Environment Configuration -->
    <script>
        // Build timestamp is static to match deployment
        const BUILD_TIMESTAMP = '20240422T172600Z';
        
        window.env = {
            // Core Configuration
            SCHEMA_VERSION: '04212025.B01',
            BUILD_DATE: BUILD_TIMESTAMP.slice(0, 8),
            BUILD_TIME: `${BUILD_TIMESTAMP.slice(9, 11)}:${BUILD_TIMESTAMP.slice(11, 13)}:${BUILD_TIMESTAMP.slice(13, 15)}`,
            BUILD_VERSION: '1.16',
            BUILD_TIMESTAMP: BUILD_TIMESTAMP,
            
            // API Configuration - Bypass for development
            RL_API_GATEWAY_ENDPOINT: "http://localhost:3000",
            RL_API_FALLBACK_ENDPOINT: "http://localhost:3001",
            RL_API_KEY: "qoCr1UHh8A9IDFA55NDdO4CYMaB9LvL66Rmrga3J",
            RL_API_TIMEOUT: 30000,
            RL_API_RETRY_ATTEMPTS: 3,
            
            // Assistant Configuration
            MERIT_ASSISTANT_ID: "asst_QoAA395ibbyMImFJERbG2hKT",
            OPENAI_PROJECT_ID: "proj_V4lrL1OSfydWCFW0zjgwrFRT",
            MERIT_ORG_ID: "recdg5Hlm3VVaBA2u",
            MERIT_FALLBACK_MODE: false,
            
            // CORS Configuration
            CORS_ORIGIN: "http://localhost:3000",
            CORS_METHODS: "GET,POST,PUT,DELETE,OPTIONS",
            CORS_HEADERS: "Content-Type,x-api-key,Authorization,X-Request-ID",
            
            // Feature Flags - Just enable what we need
            ENABLE_MOCK_MODE: false,
            SKIP_API_VALIDATION: true,  // This is the key flag we need
            DEBUG_MODE: true,
            ENABLE_ERROR_REPORTING: true
        };

        console.log('[Merit Flow] Development mode enabled');
    </script>

    <!-- Core Dependencies -->
    <script type="module" src="assets/js/client-merit-openai.js"></script>
    <script type="module" src="assets/js/client-merit-instructional-flow.js"></script>
    
    <!-- Version Display Initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            
            const month = String(centralTime.getMonth() + 1).padStart(2, '0');
            const day = String(centralTime.getDate()).padStart(2, '0');
            const year = centralTime.getFullYear();
            const buildDate = `${month}${day}${year}`;
            
            const hours = centralTime.getHours();
            const minutes = String(centralTime.getMinutes()).padStart(2, '0');
            const ampm = hours >= 12 ? 'pm' : 'am';
            const formattedHours = String(hours % 12 || 12).padStart(2, '0');
            const buildTime = `${formattedHours}:${minutes}${ampm}`;
            
            const version = '1.16';
            const displayVersion = `merit.html/${buildDate}.${buildTime}.v.${version}`;
            
            // Store for debugging and build tracking
            localStorage.setItem('meritVersion', version);
            localStorage.setItem('meritBuildDate', buildDate);
            localStorage.setItem('meritBuildTime', buildTime);
            localStorage.setItem('meritFullVersion', displayVersion);
            
            if (window.env.DEBUG_MODE) {
                console.log('[Merit Flow] Build version:', displayVersion);
            }

            // Update version display in DOM
            const versionNumber = document.getElementById('version-number');
            if (versionNumber) {
                versionNumber.textContent = version;
            }
        });
    </script>

    <!-- Connection Status -->
    <div id="connection-status" class="status-indicator connecting" role="alert" aria-live="polite">
        <span id="connection-message">Connecting to Merit...</span>
    </div>
    
    <!-- Error Banner -->
    <div id="error-banner" class="error-banner hidden" role="alert" aria-live="assertive">
        <span class="error-icon">⚠️</span>
        <span id="error-details">An error occurred</span>
        <button onclick="this.parentElement.classList.add('hidden')" aria-label="Dismiss error">
            Dismiss
        </button>
    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
        <div class="loading-spinner"></div>
        <p id="loading-message" class="loading-message">Connecting to your assistant...</p>
        <div class="loading-progress">
            <div class="progress-bar"></div>
        </div>
    </div>
    
    <!-- Version Display -->
    <div class="version-display">
        <span>v<span id="version-number">1.16</span></span>
        <span class="environment-tag">PROD</span>
        <span class="build-date">04/21/24</span>
    </div>
    
    <div class="client-layout" data-client-component="merit-page" data-test-id="page-container">
        <header class="client-header">
            <img 
                src="/clients/elpl/assets/images/client-elpl-logo-white.png"
                alt="ELPL Logo"
                class="client-logo"
                loading="lazy"
                aria-live="polite"
            />
        </header>

        <main class="client-content" role="main" data-test-id="main-content">
            <!-- Sidebar with fixed width -->
            <nav class="sidebar expanded" 
                 role="navigation" 
                 aria-label="Main navigation"
                 data-test-id="sidebar">
                <div class="sidebar-content" style="padding-top: 30px;">
                    <div class="sidebar-nav">
                        <a href="#welcome" 
                           class="nav-link active" 
                           data-section="welcome" 
                           aria-current="page"
                           data-test-id="nav-welcome">
                            <span class="nav-text">Welcome</span>
                        </a>
                        <a href="#chat" 
                           class="nav-link" 
                           data-section="chat"
                           data-test-id="nav-chat">
                            <span class="nav-text">Chat</span>
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Main content area -->
            <div class="content-area" 
                 role="region" 
                 aria-label="Main content"
                 data-test-id="content-area">
                <div class="section active" 
                     data-section="welcome" 
                     role="tabpanel" 
                     aria-labelledby="welcome-tab"
                     data-test-id="welcome-section">
                    <div class="welcome-content">
                        <h1>Welcome to Merit</h1>
                        <h2>Your EL Education Curriculum Support Assistant</h2>
                        
                        <form class="welcome-form" 
                              id="welcome-form"
                              data-test-id="welcome-form"
                              aria-label="Welcome Form">
                            <div class="form-group">
                                <label for="grade-level" id="grade-level-label">What grade level do you teach or support?</label>
                                <div class="select-wrapper">
                                    <select id="grade-level" 
                                            class="form-control" 
                                            required
                                            data-test-id="grade-select"
                                            aria-labelledby="grade-level-label"
                                            aria-describedby="grade-level-description"
                                            aria-required="true">
                                        <option value="" disabled selected>Select a grade level</option>
                                        <option value="Kindergarten">Kindergarten</option>
                                        <option value="Grade 1">Grade 1</option>
                                        <option value="Grade 2">Grade 2</option>
                                        <option value="Grade 3">Grade 3</option>
                                        <option value="Grade 4">Grade 4</option>
                                        <option value="Grade 5">Grade 5</option>
                                    </select>
                                    <span id="grade-level-description" class="sr-only">
                                        Choose your grade level from Kindergarten through Grade 5
                                    </span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="curriculum" id="curriculum-label">Which curriculum are you here with questions about?</label>
                                <div class="select-wrapper">
                                    <select id="curriculum" 
                                            class="form-control" 
                                            required
                                            data-test-id="curriculum-select"
                                            aria-labelledby="curriculum-label"
                                            aria-describedby="curriculum-description"
                                            aria-required="true">
                                        <option value="ela" selected>English Language Arts (ELA)</option>
                                    </select>
                                    <span id="curriculum-description" class="sr-only">
                                        Currently only ELA curriculum is available
                                    </span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="section" 
                     data-section="chat" 
                     role="tabpanel" 
                     aria-labelledby="chat-tab" 
                     hidden
                     data-test-id="chat-section">
                    <div class="chat-container" data-test-id="chat-container">
                        <div id="chat-window" 
                             class="chat-window" 
                             role="log" 
                             aria-live="polite"
                             aria-label="Chat conversation"
                             role="article"
                             aria-label="Assistant message"
                             data-test-id="chat-window">
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="client-footer" role="contentinfo" data-test-id="footer">
            <div class="footer-content">
                <div class="footer-spacer"></div>
                <div class="footer-center">
                    <div id="playbar" class="playbar" data-test-id="playbar" style="position: relative; z-index: 100;">
                        <button id="next-button" 
                                class="action-button" 
                                aria-label="Continue to chat"
                                data-active="true"
                                data-test-id="next-button">
                            <img src="/clients/elpl/assets/images/client-elpl-next-button.png" 
                                 alt="Next" 
                                 class="button-icon"
                                 loading="lazy">
                        </button>
                    </div>
                    <div id="chatbar" class="chatbar" hidden data-test-id="chatbar">
            <div class="chat-input-container">
                            <textarea id="chat-input"
                                    class="chat-input"
                                    aria-label="Type your message"
                    placeholder="Type your message..." 
                                    rows="1"
                                    maxlength="1000"
                                    data-test-id="chat-input"></textarea>
                        </div>
                        <button id="send-button" 
                                class="action-button"
                                aria-label="Send message"
                                data-test-id="send-button">
                            <img src="/clients/elpl/assets/images/client-elpl-send-button.png" 
                                 alt="Send" 
                                 class="button-icon"
                                 loading="lazy">
                        </button>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Copyright Footer -->
        <div class="copyright-footer" role="contentinfo" aria-label="Copyright information">
            <div>© Recursive Learning Platform</div>
        </div>
    </div>

    <!-- Persistence Prompt -->
    <div id="persistence-prompt" class="persistence-prompt" hidden>
        <h4>Save Your Progress?</h4>
        <p>Would you like to save your chat history and preferences for future sessions?</p>
        <div class="prompt-actions">
            <button class="prompt-button secondary" onclick="dismissPersistencePrompt()">Maybe Later</button>
            <button class="prompt-button primary" onclick="enablePersistence()">Save Progress</button>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('welcome-form');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Log form submission
                window.REDIS_FLOW.logStep('FORM_SUBMIT', {
                    gradeLevel: form.querySelector('#grade-level').value,
                    subject: 'ela', // hardcoded for now
                    timestamp: Date.now()
                });

                // Generate anonymous session ID
                const sessionId = `merit-${Date.now()}`;
                window.REDIS_FLOW.logStep('SESSION_CREATED', {
                    sessionId,
                    timestamp: Date.now()
                });

                try {
                    // Create Redis record
                    window.REDIS_FLOW.logStep('REDIS_WRITE_START', {
                        sessionId,
                        timestamp: Date.now()
                    });

                    // After Redis write
                    window.REDIS_FLOW.logStep('REDIS_WRITE_COMPLETE', {
                        sessionId,
                        ttl: 3600,
                        timestamp: Date.now()
                    });

                } catch (error) {
                    window.REDIS_FLOW.logError('REDIS_FLOW_ERROR', error);
                }
            });
        });
    </script>

    <!-- Error Panel for Redis Operations -->
    <div id="error-panel" class="error-panel" hidden>
        <h3>System Status</h3>
        <div class="error-list"></div>
    </div>

    <script>
        function dismissPersistencePrompt() {
            const promptPanel = document.getElementById('persistence-prompt');
            if (promptPanel) {
                promptPanel.hidden = true;
            }
            window.SESSION_FLOW.logSession(
                'unknown', // Will be filled by event handler
                'PERSISTENCE_DISMISSED',
                { timestamp: Date.now() }
            );
        }

        function enablePersistence() {
            const promptPanel = document.getElementById('persistence-prompt');
            if (promptPanel) {
                promptPanel.hidden = true;
            }
            // Emit event for persistence handling
            const event = new CustomEvent('merit-enable-persistence', {
                detail: { timestamp: Date.now() }
            });
            window.dispatchEvent(event);
            window.SESSION_FLOW.logSession(
                'unknown', // Will be filled by event handler
                'PERSISTENCE_ENABLED',
                { timestamp: Date.now() }
            );
        }
    </script>

    <!-- Debugging script added for console logging -->
    <script>
      console.log('[Merit HTML] Loaded.');
      const nextButton = document.getElementById('next-button');
      if (nextButton) {
        console.log('[Merit HTML] Next button initial state:', nextButton.disabled);
      } else {
        console.log('[Merit HTML] Next button not found.');
      }
      const gradeSelect = document.getElementById('grade-level');
      if (gradeSelect) {
        gradeSelect.addEventListener('change', function() {
          console.log('[Merit HTML] Grade level changed to:', this.value);
          console.log('[Merit HTML] Next button state after grade change:', nextButton ? nextButton.disabled : 'not found');
        });
      } else {
        console.log('[Merit HTML] Grade level select not found.');
      }
    </script>

    <!-- Set default tab to #welcome if no hash is present -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        if (!window.location.hash) {
          window.location.hash = '#welcome';
          console.log('[Merit HTML] No hash present - defaulting to #welcome');
        }
      });
    </script>

    <!-- End Debugging Script -->

    <!-- Mock API Connection Manager for Development -->
    <script>
        class APIConnectionManager {
            constructor() {
                this.connectionStatus = document.getElementById('connection-status');
                this.errorBanner = document.getElementById('error-banner');
                // Immediately show as connected in development mode
                this.updateConnectionStatus('connected');
            }

            async testConnection() {
                // Always return success in development mode
                this.updateConnectionStatus('connected');
                return true;
            }

            updateConnectionStatus(status) {
                if (this.connectionStatus) {
                    this.connectionStatus.className = `status-indicator ${status}`;
                    this.connectionStatus.querySelector('#connection-message').textContent = 
                        'Development Mode Active';
                }
            }

            showErrorBanner(message) {
                console.log('[Development] Error Banner:', message);
            }
        }

        // Initialize API Connection Manager
        document.addEventListener('DOMContentLoaded', async () => {
            const apiManager = new APIConnectionManager();
            
            // Auto-initialize Merit Flow
            if (window.MeritInstructionalFlow) {
                try {
                    const flow = new MeritInstructionalFlow({
                        gradeSelect: document.getElementById('grade-level'),
                        curriculumSelect: document.getElementById('curriculum')
                    });
                    // Mock successful initialization
                    console.log('[Development] Merit Flow initialized in mock mode');
                } catch (error) {
                    console.log('[Development] Merit Flow initialization error:', error);
                }
            }
        });
    </script>

    <!-- Development Mode Indicator -->
    <div class="dev-mode-indicator" style="position: fixed; top: 0; right: 0; background: #ff6b6b; color: white; padding: 5px 10px; font-size: 12px; z-index: 9999;">
        Development Mode
    </div>
</body>
</html> 
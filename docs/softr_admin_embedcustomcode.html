<!-- ****************************************************
     SOFTR INTEGRATION GUIDE
     
     Copy this entire block into your Softr page's custom code section
     
     ðŸ‘‡ START COPYING HERE ðŸ‘‡
**************************************************** -->
<style>
    /* Scoped Admin Dashboard Styles */
    .recursive-admin-embed {
        --ra-primary: #425563;
        --ra-secondary: #E87722;
        --ra-tertiary: #4fa997;
        --ra-bg: #f5f5f5;
        --ra-text: #2b2b2b;
        --ra-radius: 12px;
        --ra-spacing: 24px;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background: var(--ra-bg);
        min-height: 100vh;
        display: flex;
        justify-content: center;
    }

    .recursive-admin-embed #admin-container {
        width: 1900px;
        max-width: 100%;
        height: 100vh;
        position: relative;
        background: white;
    }

    .recursive-admin-embed #loading-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: var(--ra-radius);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 300px;
    }

    .recursive-admin-embed #loading-message h1 {
        color: var(--ra-primary);
        font-size: 28px;
        margin-bottom: 20px;
    }

    .recursive-admin-embed #loading-message p {
        color: var(--ra-text);
        font-size: 16px;
        margin: 10px 0;
    }

    .recursive-admin-embed #loading-status {
        color: var(--ra-secondary);
        font-size: 14px;
        margin-top: 15px;
        font-style: italic;
    }

    .recursive-admin-embed #access-denied {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.98);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--ra-spacing);
    }

    .recursive-admin-embed #access-denied h1 {
        color: var(--ra-primary);
        font-size: 32px;
        margin-bottom: var(--ra-spacing);
    }

    .recursive-admin-embed #access-denied p {
        color: var(--ra-text);
        font-size: 18px;
        line-height: 1.6;
        max-width: 600px;
        text-align: center;
        margin: 10px 0;
    }

    .recursive-admin-embed .spinner {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: var(--ra-spacing);
    }

    .recursive-admin-embed .dot {
        width: 12px;
        height: 12px;
        background: var(--ra-secondary);
        border-radius: 50%;
        animation: ra-bounce 1.4s infinite ease-in-out;
    }

    .recursive-admin-embed .dot:nth-child(1) { animation-delay: -0.32s; }
    .recursive-admin-embed .dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes ra-bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .recursive-admin-embed #iframe-container {
        width: 100%;
        height: 100vh;
        border: none;
        display: none;
    }

    /* Accessibility Enhancements */
    @media (prefers-contrast: high) {
        .recursive-admin-embed {
            background: white;
            color: black;
        }
    }
</style>

<div class="recursive-admin-embed">
    <div id="admin-container">
        <div id="loading-message">
            <h1>Welcome <span id="user-name">there</span>!</h1>
            <p>Verifying your access...</p>
            <div id="loading-status">Starting system initialization...</div>
            <div class="spinner">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>

        <div id="access-denied">
            <h1>Access Denied</h1>
            <p>You need to be logged into Integral Ed's Mothership Connection to access this page.</p>
            <p>Please ensure you're logged in with an @integral-ed.com email address.</p>
        </div>

        <iframe id="iframe-container" src=""></iframe>
    </div>
</div>

<script>
    (function() {
        const SOFTR_BASE_URL = 'https://integral-mothership.softr.app';
        const adminPageUrl = 'https://recursivelearning.app/admin/index.html';
        let checkCount = 0;
        const MAX_CHECKS = 30;
        const CHECK_INTERVAL = 10000;
        const DEBUG = true;

        function log(...args) {
            if (DEBUG) {
                console.log('[Recursive Admin]', ...args);
            }
        }

        function updateLoadingStatus(message) {
            const status = document.getElementById('loading-status');
            if (status) {
                status.textContent = message;
            }
        }

        function validateEmail(email) {
            return email && typeof email === 'string' && email.endsWith('@integral-ed.com');
        }

        function showAccessDenied() {
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('access-denied').style.display = 'flex';
            document.getElementById('iframe-container').style.display = 'none';
        }

        function showAdmin(userData) {
            log('Showing admin interface for user:', userData.Name);
            const iframe = document.getElementById('iframe-container');
            const iframeUrl = `${adminPageUrl}?User_ID=${userData.record_id}&Name=${userData.Name}&Email=${userData.email}`;
            iframe.src = iframeUrl;
            iframe.style.display = 'block';
            document.getElementById('loading-message').style.display = 'none';
            document.getElementById('access-denied').style.display = 'none';
        }

        function checkUserAccess() {
            log('Checking Softr initialization state...');
            updateLoadingStatus(`Checking system access (Attempt ${checkCount + 1}/${MAX_CHECKS})`);
            
            // Check if Softr page renderer has completed
            const softrBlocks = document.querySelectorAll('[data-block-name]');
            if (softrBlocks.length === 0) {
                log('Waiting for Softr blocks to render...');
                if (checkCount < MAX_CHECKS) {
                    checkCount++;
                    setTimeout(checkUserAccess, CHECK_INTERVAL);
                    return;
                }
                log('Timed out waiting for Softr blocks');
                showAccessDenied();
                return;
            }

            // Check if Softr user API is available
            if (typeof Softr === 'undefined' || !Softr.user?.get) {
                log('Waiting for Softr user API...');
                updateLoadingStatus('Waiting for authentication system...');
                if (checkCount < MAX_CHECKS) {
                    checkCount++;
                    setTimeout(checkUserAccess, CHECK_INTERVAL);
                    return;
                }
                log('Timed out waiting for Softr user API');
                showAccessDenied();
                return;
            }

            log('Softr initialized, fetching user data...');
            updateLoadingStatus('Verifying user credentials...');
            Softr.user.get()
                .then(userData => {
                    log('Received user data:', userData);
                    
                    if (!userData || !userData.email) {
                        log('No user email found in data');
                        showAccessDenied();
                        return;
                    }

                    if (!validateEmail(userData.email)) {
                        log('Invalid email domain:', userData.email);
                        showAccessDenied();
                        return;
                    }

                    document.getElementById('user-name').textContent = userData.Name || 'there';
                    updateLoadingStatus('Access granted, loading dashboard...');
                    showAdmin(userData);
                })
                .catch(error => {
                    log('Error getting Softr user data:', error);
                    showAccessDenied();
                });
        }

        // Wait for DOM and Softr to be ready
        log('Initializing Recursive Admin embed...');
        updateLoadingStatus('Starting system initialization...');
        if (document.readyState === 'loading') {
            log('Document still loading, waiting for DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', checkUserAccess);
        } else {
            log('Document already loaded, checking user access...');
            checkUserAccess();
        }

        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            if (event.origin === 'https://recursivelearning.app') {
                const { type, data } = event.data;
                log('Received message from admin iframe:', type, data);
                if (type === 'recursive-admin-signal' && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'recursive-admin-signal',
                        signalType: data.signalType,
                        data: data
                    }, SOFTR_BASE_URL);
                }
            }
        });
    })();
</script>
<!-- ****************************************************
     ðŸ‘† STOP COPYING HERE ðŸ‘†
**************************************************** --> 